<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#ffbc93">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Libros Club">
  <link rel="manifest" href="libros.json">
  <link rel="apple-touch-icon" href="icon-192.png">
  <title>Libros Club</title>
  <style>
    @font-face {
      font-family: 'PTSerif';
      src: url('../fonts/static/PTSerif-Regular.ttf') format('truetype');
      font-weight: 400;
      font-display: swap;
    }
    @font-face {
      font-family: 'PTSerif';
      src: url('../fonts/static/PTSerif-Bold.ttf') format('truetype');
      font-weight: 700;
      font-display: swap;
    }
    @font-face {
      font-family: 'Faustina';
      src: url('../fonts/static/Faustina-Regular.ttf') format('truetype');
      font-weight: 400;
      font-display: swap;
    }
    @font-face {
      font-family: 'Faustina';
      src: url('../fonts/static/Faustina-Bold.ttf') format('truetype');
      font-weight: 700;
      font-display: swap;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'PTSerif', Georgia, serif;
      background: linear-gradient(135deg, #ffbc93, #e89f6b);
      min-height: 100vh;
      padding: 20px;
      color: #3d2817;
      line-height: 1.6;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      background: #fdf1d5;
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    h1 {
      font-family: 'Faustina', Georgia, serif;
      font-size: 2em;
      font-weight: 700;
      text-align: center;
      margin-bottom: 5px;
      color: #6b4423;
    }

    .sottotitolo {
      text-align: center;
      color: #a0522d;
      margin-bottom: 20px;
      font-size: 1em;
    }

    .stato {
      display: none;
    }

    .stato.attivo {
      display: block;
    }

    /* STATO 1: Selezione Nome */
    .form-selezione {
      max-width: 400px;
      margin: 30px auto;
      text-align: center;
    }

    .form-selezione label {
      display: block;
      font-size: 1.2em;
      margin-bottom: 15px;
      color: #6b4423;
    }

    .form-selezione select {
      font-family: 'PTSerif', Georgia, serif;
      font-size: 1.3em;
      padding: 15px;
      width: 100%;
      border: 2px solid #d2691e;
      border-radius: 8px;
      background: #fff;
      color: #6b4423;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .form-selezione select:hover {
      border-color: #ff8c42;
      box-shadow: 0 4px 10px rgba(210, 105, 30, 0.3);
    }

    .form-selezione select:focus {
      outline: none;
      border-color: #ff6b35;
      box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.2);
    }

    /* STATO 2: Inserimento Pagine */
    .form-pagine {
      max-width: 400px;
      margin: 30px auto;
      text-align: center;
    }

    .form-pagine label {
      display: block;
      font-size: 1.2em;
      margin-bottom: 15px;
      color: #6b4423;
    }

    .form-pagine input,
    .form-pagine select {
      font-family: 'PTSerif', Georgia, serif;
      font-size: 1.5em;
      padding: 12px;
      width: 100%;
      border: 2px solid #d2691e;
      border-radius: 8px;
      text-align: center;
      margin-bottom: 20px;
    }

    .form-pagine select {
      cursor: pointer;
    }

    .form-pagine select option:disabled {
      color: #999;
    }

    .btn-primario {
      font-family: 'Faustina', Georgia, serif;
      font-size: 1.3em;
      font-weight: 700;
      padding: 15px 40px;
      background: linear-gradient(135deg, #ff6b35, #d9534f);
      color: #fff;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    }

    .btn-primario:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3);
    }

    .btn-primario:disabled {
      background: #999;
      cursor: not-allowed;
      transform: none;
    }

    /* STATO 3: Dashboard */
    .sezione-aggiornamento {
      background: #ffe8cc;
      border: 2px solid #eca677;
      border-radius: 6px;
      padding: 15px;
      margin-bottom: 20px;
    }

    .sezione-aggiornamento h2 {
      font-family: 'Faustina', Georgia, serif;
      font-size: 1.2em;
      margin-bottom: 10px;
      color: #6b4423;
    }

    .form-inline {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }

    .form-inline input {
      font-family: 'PTSerif', Georgia, serif;
      font-size: 1.1em;
      padding: 8px;
      border: 2px solid #eca677;
      border-radius: 5px;
      flex: 1;
      min-width: 120px;
    }

    /* Rimuovi freccette dagli input numerici */
    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    input[type="number"] {
      -moz-appearance: textfield;
    }

    .form-inline button {
      font-family: 'Faustina', Georgia, serif;
      font-size: 1em;
      font-weight: 700;
      padding: 8px 20px;
      background: linear-gradient(135deg, #ff8c42, #ffa94d);
      color: #fff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .form-inline button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    }

    .lista-progressioni {
      margin-top: 20px;
    }

    .lista-progressioni h2 {
      font-family: 'Faustina', Georgia, serif;
      font-size: 1.4em;
      margin-bottom: 15px;
      color: #6b4423;
      text-align: center;
    }

    #cards-container {
      background: #fff;
      border: 2px solid #ddd;
      border-radius: 8px;
      padding: 15px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .lettore-item {
      margin-bottom: 15px;
      padding-bottom: 15px;
    }

    .lettore-item:last-child {
      margin-bottom: 0;
      padding-bottom: 0;
      border-bottom: none;
    }

    /* Animazione per le barre di progressione */
    @keyframes flussoColore {
      0% {
        background-position: 0% 50%;
      }
      50% {
        background-position: 100% 50%;
      }
      100% {
        background-position: 0% 50%;
      }
    }

    @keyframes pulseGlow {
      0%, 100% {
        box-shadow: 0 2px 8px rgba(255, 107, 53, 0.3);
      }
      50% {
        box-shadow: 0 2px 12px rgba(255, 107, 53, 0.5);
      }
    }

    .lettore-item.proprio .barra-progresso {
      animation: pulseGlow 2s ease-in-out infinite;
    }

    .barra-container {
      background: #e0e0e0;
      height: 20px;
      border-radius: 10px;
      overflow: visible;
      margin-bottom: 5px;
      margin-top: 25px;
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
      position: relative;
    }

    .emoji-marker {
      position: absolute;
      top: -24px;
      font-size: 20px;
      transform: translateX(-50%);
      transition: left 0.5s ease;
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
    }

    .barra-progresso {
      height: 100%;
      border-radius: 10px;
      transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1), box-shadow 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      padding-right: 8px;
      color: #fff;
      font-weight: 700;
      font-size: 0.75em;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      background-size: 200% 200%;
      animation: flussoColore 4s ease infinite;
    }


    .info-riga {
      font-size: 0.9em;
      color: #6b5d52;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .nome-lettore {
      font-family: 'Faustina', Georgia, serif;
      font-weight: 700;
      color: #6b4423;
    }

    .info-pagine {
      color: #8b7355;
      font-size: 0.95em;
    }

    .messaggio-errore {
      background: #ffe4d6;
      border: 2px solid #d9534f;
      border-radius: 6px;
      padding: 15px;
      margin-top: 15px;
      color: #8b2500;
      text-align: center;
    }

    .messaggio-successo {
      background: #fff3e0;
      border: 2px solid #ffa94d;
      border-radius: 6px;
      padding: 15px;
      margin-top: 15px;
      color: #8b5a00;
      text-align: center;
    }

    .loading {
      text-align: center;
      padding: 20px;
      font-size: 1em;
      color: #8b7355;
    }

    /* Responsive */
    @media (max-width: 600px) {
      .container {
        padding: 20px;
      }

      h1 {
        font-size: 1.8em;
        margin-bottom:0px;
      }

      .sottotitolo {
        font-size: 1em;
      }

      .form-inline {
        flex-direction: column;
        align-items: stretch;
      }

      .form-inline input,
      .form-inline button {
        width: 100%;
      }

      .lista-progressioni h2 {
        font-size: 1.2em;
      }

      .info-riga {
        font-size: 0.85em;
      }

      #cards-container {
        padding: 12px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Libros Club</h1>
    <p class="sottotitolo">Gatto e Topo by G√ºnther Grass</p>

    <!-- STATO 1: Selezione Nome -->
    <div id="stato-selezione" class="stato">
      <div class="form-selezione">
        <label for="select-nome">Seleziona il tuo nome per iniziare</label>
        <select id="select-nome">
          <option value="">-- Scegli il tuo nome --</option>
          <option value="Andrea">Andrea</option>
          <option value="Antonio">Antonio</option>
          <option value="Carlo">Carlo</option>
          <option value="Fabrizio">Fabrizio</option>
          <option value="Gaia">Gaia</option>
          <option value="Leonardo">Leonardo</option>
          <option value="Saverio">Saverio</option>
        </select>
      </div>
    </div>

    <!-- STATO 2: Inserimento Pagine Totali -->
    <div id="stato-pagine" class="stato">
      <div class="form-pagine">
        <h2 id="benvenuto-nome"></h2>
        <label for="input-pagine-totali">Inserisci il numero di pagina in cui finisce il romanzo</label>
        <input type="number" id="input-pagine-totali" min="1" max="9999" placeholder="es. 350">
        <label for="select-emoji">Scegli la tua emoji</label>
        <select id="select-emoji">
          <option value="">Caricamento...</option>
        </select>
        <button id="btn-inizia" class="btn-primario">Lesgo</button>
        <div id="messaggio-pagine"></div>
      </div>
    </div>

    <!-- STATO 3: Dashboard Progressioni -->
    <div id="stato-dashboard" class="stato">
      <div class="sezione-aggiornamento">
        <div class="form-inline">
          <label for="input-pagina-corrente" style="flex: 0 0 auto;">Pagina attuale:</label>
          <input type="number" id="input-pagina-corrente" min="0">
          <button id="btn-aggiorna">Aggiorna</button>
        </div>
        <div id="messaggio-aggiornamento"></div>
      </div>

      <div class="lista-progressioni">
        <div id="loading" class="loading">Caricamento...</div>
        <div id="cards-container"></div>
      </div>
    </div>
  </div>

  <script>
    // Registrazione Service Worker
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js');
    }

    const API_BASE = 'https://libros-club.stompet.workers.dev';
    const STORAGE_KEY = 'gattotopo_lettore_nome';

    let nomeCorrente = null;
    let refreshInterval = null;

    // Elementi DOM
    const statoSelezione = document.getElementById('stato-selezione');
    const statoPagine = document.getElementById('stato-pagine');
    const statoDashboard = document.getElementById('stato-dashboard');

    const selectNome = document.getElementById('select-nome');
    const benvenutoNome = document.getElementById('benvenuto-nome');
    const inputPagineTotali = document.getElementById('input-pagine-totali');
    const selectEmoji = document.getElementById('select-emoji');
    const btnIniziaEl = document.getElementById('btn-inizia');
    const messaggioPagine = document.getElementById('messaggio-pagine');

    const inputPaginaCorrente = document.getElementById('input-pagina-corrente');
    const btnAggiorna = document.getElementById('btn-aggiorna');
    const messaggioAggiornamento = document.getElementById('messaggio-aggiornamento');
    const cardsContainer = document.getElementById('cards-container');
    const loadingEl = document.getElementById('loading');

    // Funzioni di utility
    function mostraStato(stato) {
      document.querySelectorAll('.stato').forEach(s => s.classList.remove('attivo'));
      stato.classList.add('attivo');
    }

    function mostraMessaggio(elemento, testo, tipo) {
      elemento.className = tipo === 'errore' ? 'messaggio-errore' : 'messaggio-successo';
      elemento.textContent = testo;
    }

    // API calls
    async function inizializzaLettore(nome, pagineTotali, emoji) {
      const response = await fetch(`${API_BASE}/inizializza-lettore`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ nome, pagineTotali, emoji })
      });
      return await response.json();
    }

    async function aggiornaProgresso(nome, paginaCorrente) {
      const response = await fetch(`${API_BASE}/aggiorna-progresso`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ nome, paginaCorrente })
      });
      return await response.json();
    }

    async function caricaProgressioni() {
      const response = await fetch(`${API_BASE}/progressioni`);
      return await response.json();
    }

    async function caricaEmojiDisponibili() {
      const response = await fetch(`${API_BASE}/emoji-disponibili`);
      return await response.json();
    }

    // Genera un colore basato sull'emoji
    function getColorFromEmoji(emoji) {
      if (!emoji) return 'linear-gradient(90deg, #95a5a6, #7f8c8d)';

      // Mappatura colori per le emoji del sito
      const emojiColors = {
        'üê∏': ['#90ee90', '#3cb371'], // Verde rana
        'üêù': ['#ffd700', '#ff8c00'], // Giallo/Arancione ape
        'üêô': ['#ff6b9d', '#ff1493'], // Rosa/Viola polpo
        'üêÆ': ['#d4a574', '#a0826d'], // Marrone chiaro mucca
        'üê¥': ['#8b6f47', '#654321'], // Marrone cavallo
        'üê∑': ['#ffb6c1', '#ff69b4'], // Rosa maialino
        'üê§': ['#fff44f', '#ffd700'], // Giallo pulcino
      };

      // Se troviamo una corrispondenza diretta, usiamo quei colori
      if (emojiColors[emoji]) {
        const [c1, c2] = emojiColors[emoji];
        return `linear-gradient(135deg, ${c1}, ${c2})`;
      }

      // Altrimenti generiamo un colore basato sull'hash dell'emoji
      let hash = 0;
      for (let i = 0; i < emoji.length; i++) {
        hash = emoji.charCodeAt(i) + ((hash << 5) - hash);
      }

      // Genera HSL con hue basato sull'hash, saturazione e luminosit√† fisse per colori vivaci
      const hue = Math.abs(hash % 360);
      const saturation = 70 + (Math.abs(hash) % 15); // 70-85%
      const lightness = 50 + (Math.abs(hash >> 8) % 10); // 50-60%

      const color1 = `hsl(${hue}, ${saturation}%, ${lightness}%)`;
      const color2 = `hsl(${(hue + 30) % 360}, ${saturation}%, ${lightness - 10}%)`;

      return `linear-gradient(135deg, ${color1}, ${color2})`;
    }

    // Render dashboard
    function renderProgressioni(data) {
      loadingEl.style.display = 'none';
      cardsContainer.innerHTML = '';

      if (!data.lettori || data.lettori.length === 0) {
        cardsContainer.innerHTML = '<p style="text-align: center; color: #999;">Nessuna progressione disponibile</p>';
        return;
      }

      data.lettori.forEach(lettore => {
        const item = document.createElement('div');
        item.className = 'lettore-item';
        if (lettore.nome === nomeCorrente) {
          item.classList.add('proprio');
        }

        const percentuale = lettore.percentuale || 0;
        const completata = percentuale >= 100;
        const emojiPosizione = Math.min(percentuale, 100);

        // Genera colore dalla emoji (se non completata)
        const coloreBarra = completata
          ? 'linear-gradient(90deg, #27ae60, #229954)'
          : getColorFromEmoji(lettore.emoji);

        item.innerHTML = `
          <div class="barra-container">
            ${lettore.emoji ? `<span class="emoji-marker" style="left: ${emojiPosizione}%">${lettore.emoji}</span>` : ''}
            <div class="barra-progresso ${completata ? 'completata' : ''}" style="width: ${emojiPosizione}%; background: ${coloreBarra}">
              ${percentuale > 20 ? percentuale.toFixed(1) + '%' : ''}
            </div>
          </div>
          <div class="info-riga">
            <span class="nome-lettore">${lettore.nome}</span>
            <span class="info-pagine">Pagina ${lettore.paginaCorrente} di ${lettore.pagineTotali}</span>
          </div>
        `;

        cardsContainer.appendChild(item);
      });
    }

    async function refreshDashboard() {
      try {
        const data = await caricaProgressioni();
        renderProgressioni(data);
      } catch (error) {
        console.error('Errore refresh:', error);
      }
    }

    // Event handlers
    selectNome.addEventListener('change', async () => {
      const nome = selectNome.value;

      if (!nome) return; // Se seleziona l'opzione vuota, non fa nulla

      nomeCorrente = nome;
      localStorage.setItem(STORAGE_KEY, nome);

      // Verifica se gi√† inizializzato
      try {
        const data = await caricaProgressioni();
        const lettoreEsistente = data.lettori.find(l => l.nome === nome);

        if (lettoreEsistente && lettoreEsistente.pagineTotali) {
          // Vai direttamente alla dashboard
          mostraStato(statoDashboard);
          refreshDashboard();
          startAutoRefresh();
        } else {
          // Vai a inserimento pagine totali
          benvenutoNome.textContent = `Benvenuto, ${nome}!`;
          mostraStato(statoPagine);
          // Carica emoji disponibili
          await caricaEPopolarEmoji();
        }
      } catch (error) {
        benvenutoNome.textContent = `Benvenuto, ${nome}!`;
        mostraStato(statoPagine);
        await caricaEPopolarEmoji();
      }
    });

    // Funzione helper per caricare e popolare select emoji
    async function caricaEPopolarEmoji() {
      try {
        const data = await caricaEmojiDisponibili();
        selectEmoji.innerHTML = '<option value="">-- Scegli la tua emoji --</option>';
        data.emoji.forEach(item => {
          const option = document.createElement('option');
          option.value = item.emoji;
          option.textContent = item.emoji;
          if (!item.disponibile) {
            option.disabled = true;
            option.textContent = `${item.emoji} (${item.usataDa})`;
          }
          selectEmoji.appendChild(option);
        });
      } catch (error) {
        selectEmoji.innerHTML = '<option value="">Errore caricamento emoji</option>';
        console.error('Errore caricamento emoji:', error);
      }
    }

    btnIniziaEl.addEventListener('click', async () => {
      const pagineTotali = parseInt(inputPagineTotali.value);
      const emoji = selectEmoji.value;

      if (!pagineTotali || pagineTotali < 1 || pagineTotali > 9999) {
        mostraMessaggio(messaggioPagine, 'Inserisci un numero valido tra 1 e 9999', 'errore');
        return;
      }

      if (!emoji) {
        mostraMessaggio(messaggioPagine, 'Seleziona una emoji', 'errore');
        return;
      }

      btnIniziaEl.disabled = true;
      btnIniziaEl.textContent = 'Inizializzazione...';

      try {
        const data = await inizializzaLettore(nomeCorrente, pagineTotali, emoji);

        if (data.ok) {
          mostraStato(statoDashboard);
          refreshDashboard();
          startAutoRefresh();
        } else {
          mostraMessaggio(messaggioPagine, data.error || 'Errore sconosciuto', 'errore');
          btnIniziaEl.disabled = false;
          btnIniziaEl.textContent = 'Inizia a leggere';
        }
      } catch (error) {
        mostraMessaggio(messaggioPagine, 'Errore di connessione: ' + error.message, 'errore');
        btnIniziaEl.disabled = false;
        btnIniziaEl.textContent = 'Inizia a leggere';
      }
    });

    btnAggiorna.addEventListener('click', async () => {
      const paginaCorrente = parseInt(inputPaginaCorrente.value);

      if (paginaCorrente === undefined || paginaCorrente === null || paginaCorrente < 0) {
        mostraMessaggio(messaggioAggiornamento, 'Inserisci un numero valido >= 0', 'errore');
        return;
      }

      btnAggiorna.disabled = true;
      btnAggiorna.textContent = 'Aggiornamento...';

      try {
        const data = await aggiornaProgresso(nomeCorrente, paginaCorrente);

        if (data.ok) {
          // Successo: pulisci l'input e aggiorna senza mostrare notifiche
          inputPaginaCorrente.value = '';
          messaggioAggiornamento.textContent = '';
          refreshDashboard();
        } else {
          mostraMessaggio(messaggioAggiornamento, data.error || 'Errore sconosciuto', 'errore');
        }
      } catch (error) {
        mostraMessaggio(messaggioAggiornamento, 'Errore di connessione: ' + error.message, 'errore');
      } finally {
        btnAggiorna.disabled = false;
        btnAggiorna.textContent = 'Aggiorna';
      }
    });

    // Auto-refresh
    function startAutoRefresh() {
      if (refreshInterval) clearInterval(refreshInterval);
      refreshInterval = setInterval(refreshDashboard, 30000); // 30 secondi
    }

    // Inizializzazione
    (function init() {
      const nomeSalvato = localStorage.getItem(STORAGE_KEY);

      if (nomeSalvato) {
        nomeCorrente = nomeSalvato;
        // Verifica se gi√† inizializzato
        caricaProgressioni().then(data => {
          const lettoreEsistente = data.lettori.find(l => l.nome === nomeSalvato);

          if (lettoreEsistente && lettoreEsistente.pagineTotali) {
            mostraStato(statoDashboard);
            refreshDashboard();
            startAutoRefresh();
          } else {
            benvenutoNome.textContent = `Benvenuto, ${nomeSalvato}!`;
            mostraStato(statoPagine);
            caricaEPopolarEmoji();
          }
        }).catch(() => {
          benvenutoNome.textContent = `Benvenuto, ${nomeSalvato}!`;
          mostraStato(statoPagine);
          caricaEPopolarEmoji();
        });
      } else {
        mostraStato(statoSelezione);
      }
    })();
  </script>
</body>
</html>
