<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <link rel="manifest" href="marcoaurelio.json?v=2">
    <meta name="theme-color" content="#000000">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/x-icon" href="../assets/ico.ico">
    <link rel="stylesheet" href="../css/ciessesse.css">
    <title>Daily Marchino</title>
</head>
<body style="margin: 0; padding: 30px 10px; min-height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; line-height: 1.3; box-sizing: border-box;">

<div id="ciao" class="blogpost" style="max-width: 800px; text-align: center;">
    <blockquote id="citazione-marco" style="font-style: italic; padding-left: 20px; border-left: 2px solid #000; text-align: left; margin: 0 0 1rem;">
    </blockquote>
</div>

<button id="btn-notifiche" style="margin-top: 2rem; padding: 10px 20px; cursor: pointer; display: none;">
    ðŸ”” Attiva notifiche giornaliere
</button>

<script src="../newtab/js/citazioni.js"></script>
<script>
  // Citazione del giorno
  const oggi = new Date();
  const giornoAnno = Math.floor((oggi - new Date(oggi.getFullYear(), 0, 0)) / 86400000);
  const casuale = giornoAnno % citazioni.length;
  document.getElementById("citazione-marco").innerText = citazioni[casuale];

  // Service Worker e Push
  const BACKEND = 'https://marchino-backend.onrender.com';
  const VAPID_PUBLIC = 'BHshecvYTBqVGoL9i-1Sar-FZ4YUyrySqtPvzRdua8N_emCE3XpvsEEDSNmCDr23I_txaYOy1qlxOhV2ROwRPuQ';

  if ('serviceWorker' in navigator && 'PushManager' in window) {
    navigator.serviceWorker.register('./sw.js')
      .then(reg => {
        console.log('SW registrato');
        initPush(reg);
      });
  }

  async function initPush(reg) {
    const btn = document.getElementById('btn-notifiche');
    const subscription = await reg.pushManager.getSubscription();

    if (subscription) {
      btn.textContent = 'ðŸ”•';
    }
    btn.style.display = 'block';

    btn.addEventListener('click', async () => {
      const currentSub = await reg.pushManager.getSubscription();

      if (currentSub) {
        await fetch(`${BACKEND}/unsubscribe`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ endpoint: currentSub.endpoint })
        });
        await currentSub.unsubscribe();
        btn.textContent = 'ðŸ””';
      } else {
        const newSub = await reg.pushManager.subscribe({
          userVisibleOnly: true,
          applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC)
        });
        await fetch(`${BACKEND}/subscribe`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(newSub.toJSON())
        });
        btn.textContent = 'ðŸ”•';
      }
    });
  }

  function urlBase64ToUint8Array(base64String) {
    const padding = '='.repeat((4 - base64String.length % 4) % 4);
    const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
    const raw = atob(base64);
    return Uint8Array.from([...raw].map(c => c.charCodeAt(0)));
  }
</script>
</body>
</html>
